<!DOCTYPE html>
<html>

<head>
    <title>Methods Example</title>
    <link rel="stylesheet" href="../css/pico.css">
</head>

<body>
    <main class="container">
        <a href="index.html">
            <h4>‚Üê</h4>
        </a>
        <h1>Methods üì¨</h1>
        <div class="grid">
            <article>
                <form action="https://httpbin.org/get" method="GET">
                    <input type="text" name="text_field" value="Oi" required>
                    <input type="submit" value="GET">
                </form>
            </article>
            <article>
                <form action="https://httpbin.org/post" method="POST">
                    <input type="text" name="text_field" value="Hello" required>
                    <input type="submit" value="POST">
                </form>
            </article>
            <article>
                <form action="https://httpbin.org/delete" method="DELETE">
                    <input type="hidden" name="_method" value="DELETE">
                    <input type="text" name="text_field" value="Bonjour" required>
                    <button type="submit">DELETE</button>
                </form>
            </article>
        </div>

        <h4>Request</h4>
        <pre id="requestDisplay" aria-busy="false"> </pre>
        <h4>Response</h4>
        <pre id="responseDisplay" aria-busy="false"> </pre>
    </main>

    <script>
        const requestDisplay = document.getElementById('requestDisplay');
        const responseDisplay = document.getElementById('responseDisplay');

        const forms = document.querySelectorAll('form');

        forms.forEach(form => {
            form.addEventListener('submit', (event) => {
                event.preventDefault();

                const formData = new FormData(form);
                const action = form.action;
                const method = formData.get('_method') || form.method.toUpperCase();

                requestDisplay.setAttribute('aria-busy', 'true');
                responseDisplay.setAttribute('aria-busy', 'true');
                requestDisplay.innerHTML = '\n\n';
                responseDisplay.innerHTML = '\n\n';

                let url;

                if (method === 'GET') {
                    url = `${action}?${new URLSearchParams(formData).toString()}`;
                    body = null;
                } else {
                    url = action;
                    body = formData;
                }

                const request = new Request(url, {
                    method: method,
                    body: body
                });

                requestDisplay.innerHTML = `
                METHOD:  ${request.method}
                URL:     ${request.url}
                HEADERS: ${JSON.stringify(Object.fromEntries(request.headers.entries()), null, 2)}
                BODY:    ${request.body ? JSON.stringify(Object.fromEntries(formData.entries()), null, 2) : ''}
                `.replace(/^\s+/gm, '');

                requestDisplay.setAttribute('aria-busy', 'false');

                fetch(request)
                    .then(response => {
                        const headers = response.headers;
                        const status = `${response.status} ${response.statusText}`;
                        const contentType = headers.get('content-type');
                        const headerEntries = Array.from(headers.entries());
                        const headerString = headerEntries.map(([key, value]) => `${key}: ${value}`).join('\r\n');
                        return response.text().then(body => {
                            const rawResponse = `HTTP/1.1 ${status}\r\n${headerString}\r\n\r\n${body}`;
                            return rawResponse;
                        });
                    })
                    .then(rawResponse => {
                        responseDisplay.innerHTML = rawResponse;
                    })
                    .catch((error) => {
                        responseDisplay.innerHTML = error;
                    })
                    .finally(() => {
                        responseDisplay.setAttribute('aria-busy', 'false');
                    });
            });
        });
    </script>
</body>

</html>